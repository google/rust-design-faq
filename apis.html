<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Questions about your APIs - cppfaq.rs</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="code.html"><strong aria-hidden="true">2.</strong> Questions about code in function bodies</a></li><li class="chapter-item expanded "><a href="signatures.html"><strong aria-hidden="true">3.</strong> Questions about your function signatures</a></li><li class="chapter-item expanded "><a href="types.html"><strong aria-hidden="true">4.</strong> Questions about your types</a></li><li class="chapter-item expanded "><a href="apis.html" class="active"><strong aria-hidden="true">5.</strong> Questions about your APIs</a></li><li class="chapter-item expanded "><a href="codebase.html"><strong aria-hidden="true">6.</strong> Questions about your whole codebase</a></li><li class="chapter-item expanded "><a href="processes.html"><strong aria-hidden="true">7.</strong> Questions about your processes</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">cppfaq.rs</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/google/rust-design-faq" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="questions-about-designing-apis-for-others"><a class="header" href="#questions-about-designing-apis-for-others">Questions about designing APIs for others</a></h1>
<ul>
<li><a href="#when-should-my-type-implement-default">When should my type implement <code>Default</code>?</a></li>
<li><a href="#when-should-my-type-implement-from-into-and-tryfrom">When should my type implement <code>From</code>, <code>Into</code> and <code>TryFrom</code>?</a></li>
<li><a href="#how-should-i-expose-constructors">How should I expose constructors?</a></li>
<li><a href="#when-should-my-type-implement-asref">When should my type implement <code>AsRef</code>?</a></li>
<li><a href="#when-should-i-implement-copy">When should I implement <code>Copy</code>?</a></li>
<li><a href="#should-i-have-arc-or-rc-in-my-api">Should I have <code>Arc</code> or <code>Rc</code> in my API?</a></li>
<li><a href="#should-my-api-be-thread-safe-what-does-that-mean">Should my API be thread-safe? What does that mean?</a></li>
<li><a href="#what-should-i-derive-to-make-my-code-optimally-usable">What should I <code>Derive</code> to make my code optimally usable?</a></li>
<li><a href="#how-should-i-think-about-api-design-differently-from-c">How should I think about API design, differently from C++?</a></li>
</ul>
<p>See also the excellent <a href="https://rust-lang.github.io/api-guidelines/about.html">Rust API guidelines</a>.
The document you're reading aims to provide extra hints which may be especially
useful to folk coming from C++, but that's the canonical reference.</p>
<h2 id="when-should-my-type-implement-default"><a class="header" href="#when-should-my-type-implement-default">When should my type implement <code>Default</code>?</a></h2>
<p>Whenever you'd provide a default constructor in C++.</p>
<h2 id="when-should-my-type-implement-from-into-and-tryfrom"><a class="header" href="#when-should-my-type-implement-from-into-and-tryfrom">When should my type implement <code>From</code>, <code>Into</code> and <code>TryFrom</code>?</a></h2>
<p>You should think of these as equivalent to implicit conversions in C++. Just
as with C++, if there are <em>multiple</em> ways to convert from your thing to another
thing, don't implement these, but if there's a single obvious conversion, do.</p>
<p>Usually, don't implement <code>Into</code> but instead implement <code>From</code>.</p>
<h2 id="how-should-i-expose-constructors"><a class="header" href="#how-should-i-expose-constructors">How should I expose constructors?</a></h2>
<p>See the previous two answers: where it's simple and obvious, use the standard
traits to make your object behavior predictable.</p>
<p>If you need to go beyond that, remember you've got a couple of extra toys in Rust:</p>
<ul>
<li>A &quot;constructor&quot; could return a <code>Result&lt;Self&gt;</code></li>
<li>Your constructors can have names, e.g. <code>Vec::with_capacity</code>, <code>Box::pin</code></li>
</ul>
<h2 id="when-should-my-type-implement-asref"><a class="header" href="#when-should-my-type-implement-asref">When should my type implement <code>AsRef</code>?</a></h2>
<p>If you have a type which contains another type, provide <code>AsRef</code> especially
so that people can clone the inner type. It's good practice to provide explicit
versions as well (for example, <code>String</code> implements <code>AsRef&lt;str&gt;</code> but also
provides <code>.as_str()</code>.)</p>
<h2 id="when-should-i-implement-copy"><a class="header" href="#when-should-i-implement-copy">When should I implement <code>Copy</code>?</a></h2>
<blockquote>
<p>Anything that is integer-like or reference-like should be <code>Copy</code>; other things
shouldn’t. - MY</p>
</blockquote>
<blockquote>
<p>When it's efficient and when it’s an API contact you're willing to uphold. - AH</p>
</blockquote>
<p>Generally speaking, types which are plain-old-data can be <code>Copy</code>. Anything
more nuanced with any type of state shouldn't be.</p>
<h2 id="should-i-have-arc-or-rc-in-my-api"><a class="header" href="#should-i-have-arc-or-rc-in-my-api">Should I have <code>Arc</code> or <code>Rc</code> in my API?</a></h2>
<blockquote>
<p>It’s a code smell to have reference counts in your API design. You should hide
it. - TM.</p>
</blockquote>
<p>If you must, you will need to decide between <code>Rc</code> and <code>Arc</code> - see the next
answer for some considerations. But, generally, <code>Arc</code> is better practice because
it imposes fewer restrictions on your callers. Also, consider taking a look at the
<a href="https://docs.rs/archery/latest/archery/"><code>Archery</code> crate</a>.</p>
<h2 id="should-my-api-be-thread-safe-what-does-that-mean"><a class="header" href="#should-my-api-be-thread-safe-what-does-that-mean">Should my API be thread-safe? What does that mean?</a></h2>
<p>In C++, a thread-safe API usually means that you can expect your API's
consumers to use objects from multiple threads. This is difficult to make safe
and therefore substantial extra engineering is required to make an API
thread-safe.</p>
<p>In Rust, things differ:</p>
<ul>
<li>it's more normal to do things across multiple threads;</li>
<li>you don't have to worry about your callers making mistakes here because
the compiler won't let them;</li>
<li>you can often rely on <code>Send</code> rather than <code>Sync</code>.</li>
</ul>
<p>You certainly shouldn't be putting a <code>Mutex</code> around all your types. If your
caller attempts to use the type from multiple threads, the compiler will
simply stop them. It is the responsibility of the caller to use things
safely.</p>
<blockquote>
<p>If the library has <code>Arc</code> or <code>Rc</code> in the APIs, it may be making choices about
how you should instantiate stuff, and that’s rude. - AF</p>
</blockquote>
<p>There's a reasonable chance that your API can be used in parallel threads
by virtue of <code>Send</code> and <code>Sync</code> being automatically derived. But - you should
think through the usage model for your API clients and ensure that's true.</p>
<pre><pre class="playground"><code class="language-rust">use std::cell::RefCell;
use std::collections::VecDeque;
use std::sync::Mutex;
use std::thread;

// Imagine this is your library, exposing this interface to library
// consumers...
mod pizza_api {

    use std::thread;
    use std::time::Duration;

    pub struct Pizza {
        // automatically 'Send'
        _anchovies: u32,
        _pepperoni: u32,
    }

    pub fn make_pizza() -&gt; Pizza {
        println!(&quot;cooking...&quot;);
        thread::sleep(Duration::from_millis(10));
        Pizza {
            _anchovies: 0, // yuck
            _pepperoni: 32,
        }
    }

    pub fn eat_pizza(_pizza: Pizza) {
        println!(&quot;yum&quot;)
    }
}

// Absolutely no changes are required to the pizza library to let
// it be usable from a multithreaded context
fn main() {
    let pizza_queue = Mutex::new(RefCell::new(VecDeque::new()));
    thread::scope(|s| {
        s.spawn(|| {
            let mut pizzas_eaten = 0;
            while pizzas_eaten &lt; 100 {
                if let Some(pizza) = pizza_queue.lock().unwrap().borrow_mut().pop_front() {
                    pizza_api::eat_pizza(pizza);
                    pizzas_eaten += 1;
                }
            }
        });
        s.spawn(|| {
            for _ in 0..100 {
                let pizza = pizza_api::make_pizza();
                pizza_queue.lock().unwrap().borrow_mut().push_back(pizza);
            }
        });
    });
}
</code></pre></pre>
<h2 id="what-should-i-derive-to-make-my-code-optimally-usable"><a class="header" href="#what-should-i-derive-to-make-my-code-optimally-usable">What should I <code>Derive</code> to make my code optimally usable?</a></h2>
<p>The <a href="https://rust-lang.github.io/api-guidelines/interoperability.html#types-eagerly-implement-common-traits-c-common-traits">official guidelines say to be eager</a>.</p>
<p>But don't overpromise:</p>
<blockquote>
<p>Equality can suddenly become expensive later - don’t make types comparable
unless you intend people to be able to compare instances of the type.
Allowing people to pattern match on enums is usually better. - MY</p>
</blockquote>
<p>Note that <a href="https://docs.rs/syn/latest/syn/"><code>syn</code> is a rare case</a> in that it
has so many types, and is so extensively depended upon by the rest of the Rust
ecosystem, that it avoids deriving the standard traits unless explicitly
commanded to do so via a cargo feature. This is an unusual pattern and should
not normally be followed.</p>
<h2 id="how-should-i-think-about-api-design-differently-from-c"><a class="header" href="#how-should-i-think-about-api-design-differently-from-c">How should I think about API design, differently from C++?</a></h2>
<blockquote>
<p>Make the most of the fact that everything is immutable by default. Things
which are mutable should stick out. - AF</p>
</blockquote>
<blockquote>
<p>Think about things which should take self and return self. - AF</p>
</blockquote>
<p>Refactoring is less expensive in Rust than C++ due to compiler safeguards, but
<em>rearchitecting</em> is expensive in any language. Think about &quot;one way doors&quot;
and &quot;two way doors&quot; in the design space: can you undo a change later?</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="types.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="codebase.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="types.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="codebase.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="third_party/mermaid/mermaid.min.js"></script>
                <script type="text/javascript" src="third_party/mermaid/mermaid-init.js"></script>
        
        
    </body>
</html>
